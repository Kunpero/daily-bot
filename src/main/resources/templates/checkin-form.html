<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit} ? 'Edit Check-In - Daily Bot' : 'Create Check-In - Daily Bot'">Create Check-In - Daily Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-content {
            padding: 2rem 0;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
        }
        .card-header {
            background: linear-gradient(135deg, #4A154B 0%, #3a0f3a 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4A154B 0%, #3a0f3a 100%);
            border: none;
            border-radius: 8px;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #3a0f3a 0%, #2a0b2a 100%);
            transform: translateY(-1px);
        }
        .btn-secondary {
            border-radius: 8px;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .form-control:focus, .form-select:focus {
            border-color: #4A154B;
            box-shadow: 0 0 0 0.2rem rgba(74, 21, 75, 0.25);
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .character-count {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .character-count.warning {
            color: #fd7e14;
        }
        .character-count.danger {
            color: #dc3545;
        }
        .question-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }
        .question-item:hover {
            border-color: #4A154B;
            background: #f0f0f0;
        }
        .question-item.sortable-ghost {
            opacity: 0.4;
        }
        .question-item.sortable-chosen {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .question-handle {
            cursor: grab;
            color: #6c757d;
            font-size: 1.2rem;
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .question-handle:active {
            cursor: grabbing;
        }
        .question-content {
            margin-left: 30px;
        }
        .question-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .question-item:hover .question-actions {
            opacity: 1;
        }
        .questions-container {
            min-height: 200px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            background: #fafafa;
        }
        .questions-container.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        .question-number {
            background: #4A154B;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 10px;
        }
        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .auto-add-indicator {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #1976d2;
        }
        /* Select2 styles */
        .select2-container { width: 100% !important; }
        .select2-container--bootstrap-5 .select2-selection {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            min-height: 38px;
        }
        .select2-container--bootstrap-5 .select2-selection:focus {
            border-color: #4A154B;
            box-shadow: 0 0 0 0.2rem rgba(74, 21, 75, 0.25);
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            background: #4A154B;
            border: 1px solid #4A154B;
            border-radius: 6px;
            color: #fff;
            padding: 2px 8px;
            margin: 2px;
        }
        .member-option { display: flex; align-items: center; gap: 8px; }
        .member-option img { width: 22px; height: 22px; border-radius: 50%; object-fit: cover; }
        .member-option .name { font-weight: 500; color: #333; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fab fa-slack me-2"></i>
                Daily Bot
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/checkin">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Check-Ins
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Success/Error Messages -->
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Form Card -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-edit me-2"></i>
                            <span th:text="${isEdit} ? 'Edit Check-In' : 'Create New Check-In'">Create New Check-In</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <form th:action="${isEdit} ? @{/checkin/{uuid}/edit(uuid=${checkInForm.uuid})} : @{/checkin/create}"
                              th:object="${checkInForm}" method="post" id="checkinForm">
                            
                            <!-- Name Field -->
                            <div class="mb-4">
                                <label for="name" class="form-label">
                                    <i class="fas fa-tag me-1"></i>
                                    Check-In Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       th:field="*{name}" 
                                       placeholder="Enter a name for this check-in session..."
                                       maxlength="255" required>
                                <div class="character-count mt-1">
                                    <span id="nameCount">0</span>/255 characters
                                </div>
                            </div>
                            
                            <!-- Intro Message -->
                            <div class="mb-4">
                                <label for="introMessage" class="form-label">
                                    <i class="fas fa-comment-dots me-1"></i>
                                    Intro Message
                                </label>
                                <textarea class="form-control" id="introMessage" name="introMessage" 
                                          th:field="*{introMessage}" rows="4" 
                                          placeholder="Enter the introduction message for the check-in session..."
                                          maxlength="1000"></textarea>
                                <div class="character-count mt-1">
                                    <span id="introCount">0</span>/1000 characters
                                </div>
                            </div>

                            <!-- Members (Slack users) Multi-select -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-users me-1"></i>
                                    Select Members
                                </label>
                                <select class="form-select" id="membersSelect" multiple>
                                    <option th:each="user : ${activeUsers != null ? activeUsers : slackUsers}"
                                            th:value="${user.id}"
                                            th:data-real-name="${user.realName}"
                                            th:data-image-url="${user.profileImage24}"
                                            th:text="${user.realName}">
                                    </option>
                                </select>
                                <div th:if="${activeUsers == null and (slackUsers == null or slackUsers.isEmpty())}" class="text-muted small mt-2">
                                    No active Slack users available.
                                </div>
                            </div>

                            <!-- Questions Section -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label mb-0">
                                        <i class="fas fa-question-circle me-1"></i>
                                        Questions
                                    </label>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addQuestionBtn">
                                        <i class="fas fa-plus me-1"></i>
                                        Add Question
                                    </button>
                                </div>
                                
                                <div class="auto-add-indicator">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Auto-add feature:</strong> Start typing in the last question to automatically add a new one!
                                </div>
                                
                                <div class="questions-container" id="questionsContainer">
                                    <div class="text-center text-muted py-4" id="emptyQuestionsMessage">
                                        <i class="fas fa-question-circle fa-2x mb-2"></i>
                                        <p class="mb-0">No questions added yet. Start typing to add your first question!</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Outro Message -->
                            <div class="mb-4">
                                <label for="outroMessage" class="form-label">
                                    <i class="fas fa-comment-dots me-1"></i>
                                    Outro Message
                                </label>
                                <textarea class="form-control" id="outroMessage" name="outroMessage" 
                                          th:field="*{outroMessage}" rows="4" 
                                          placeholder="Enter the conclusion message for the check-in session..."
                                          maxlength="1000"></textarea>
                                <div class="character-count mt-1">
                                    <span id="outroCount">0</span>/1000 characters
                                </div>
                            </div>

                            <!-- Help Text -->
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Tips:</strong>
                                <ul class="mb-0 mt-2">
                                    <li><strong>Name is required</strong> - Choose a descriptive name for your check-in session</li>
                                    <li><strong>Questions are optional</strong> - Add questions to gather specific information from participants</li>
                                    <li>Drag and drop questions to reorder them using the â˜° handle</li>
                                    <li>Start typing in the last question to automatically add a new one</li>
                                    <li>Both intro and outro messages are optional</li>
                                </ul>
                            </div>

                            <!-- Form Actions -->
                            <div class="d-flex justify-content-between">
                                <a href="/checkin" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i>
                                    Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    <span th:text="${isEdit} ? 'Update Check-In' : 'Create Check-In'">Create Check-In</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Preview Card -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Live Preview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="previewContent">
                            <div class="text-muted text-center">
                                <i class="fas fa-eye-slash fa-2x mb-2"></i>
                                <p>Start typing to see a preview of your check-in</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script th:inline="javascript">
        let questionCounter = 0;
        let sortable;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharacterCounts();
            initializeQuestions();
            initializeSortable();
            initializeMembers();
        });

        // Character count functionality
        function updateCharacterCount(textareaId, countId, maxLength) {
            const textarea = document.getElementById(textareaId);
            const countElement = document.getElementById(countId);
            
            function updateCount() {
                const count = textarea.value.length;
                countElement.textContent = count;
                
                countElement.className = 'character-count mt-1';
                if (count > maxLength * 0.9) {
                    countElement.classList.add('danger');
                } else if (count > maxLength * 0.7) {
                    countElement.classList.add('warning');
                }
            }
            
            textarea.addEventListener('input', updateCount);
            updateCount();
        }

        function initializeCharacterCounts() {
            updateCharacterCount('name', 'nameCount', 255);
            updateCharacterCount('introMessage', 'introCount', 1000);
            updateCharacterCount('outroMessage', 'outroCount', 1000);
        }

        // Question management
        function initializeQuestions() {
            // Load existing questions from form data
            const existingQuestions = /*[[${checkInForm.questions}]]*/ [];
            if (existingQuestions && existingQuestions.length > 0) {
                existingQuestions.forEach(question => {
                    addQuestion(question);
                });
            } else {
                // Start with one empty question
                addQuestion();
            }

            // Add question button
            document.getElementById('addQuestionBtn').addEventListener('click', function() {
                addQuestion();
            });
        }

        function addQuestion(questionData = null) {
            const container = document.getElementById('questionsContainer');
            const questionId = questionData ? questionData.uuid : generateUUID();
            const questionNumber = container.querySelectorAll('.question-item').length + 1;
            
            const questionHtml = `
                <div class="question-item" data-question-id="${questionId}">
                    <i class="fas fa-grip-vertical question-handle"></i>
                    <div class="question-actions">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-question">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="question-content">
                        <div class="question-header">
                            <div class="question-number">${questionNumber}</div>
                            <div class="flex-grow-1">
                                <input type="text" class="form-control question-text" 
                                       placeholder="Enter your question..." 
                                       maxlength="500" 
                                       value="${questionData ? questionData.text || '' : ''}">
                                <div class="character-count mt-1">
                                    <span class="question-text-count">0</span>/500 characters
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', questionHtml);
            
            // Add event listeners to the new question
            const newQuestion = container.lastElementChild;
            const questionText = newQuestion.querySelector('.question-text');
            const questionTextCount = newQuestion.querySelector('.question-text-count');
            
            // Character count for question text
            questionText.addEventListener('input', function() {
                const count = this.value.length;
                questionTextCount.textContent = count;
                questionTextCount.className = 'character-count mt-1';
                if (count > 450) {
                    questionTextCount.classList.add('danger');
                } else if (count > 350) {
                    questionTextCount.classList.add('warning');
                }
                
                // Auto-add new question when typing in the last question
                if (isLastQuestion(newQuestion) && this.value.trim().length > 0) {
                    setTimeout(() => {
                        if (isLastQuestion(newQuestion) && this.value.trim().length > 0) {
                            addQuestion();
                        }
                    }, 500);
                }
                
                updatePreview();
            });

            // Remove button
            newQuestion.querySelector('.remove-question').addEventListener('click', function() {
                newQuestion.remove();
                updateQuestionNumbers();
                updatePreview();
                updateQuestionsContainer();
            });

            updateQuestionsContainer();
            updatePreview();
        }

        function isLastQuestion(questionElement) {
            const container = document.getElementById('questionsContainer');
            const questions = container.querySelectorAll('.question-item');
            return questions.length > 0 && questions[questions.length - 1] === questionElement;
        }

        function updateQuestionNumbers() {
            const container = document.getElementById('questionsContainer');
            const questions = container.querySelectorAll('.question-item');
            questions.forEach((question, index) => {
                const numberElement = question.querySelector('.question-number');
                if (numberElement) {
                    numberElement.textContent = index + 1;
                }
            });
        }

        function updateQuestionsContainer() {
            const container = document.getElementById('questionsContainer');
            const questions = container.querySelectorAll('.question-item');
            const emptyMessage = document.getElementById('emptyQuestionsMessage');
            
            if (questions.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
            }
        }

        // Sortable functionality
        function initializeSortable() {
            const container = document.getElementById('questionsContainer');
            sortable = new Sortable(container, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                handle: '.question-handle',
                onEnd: function(evt) {
                    updateQuestionNumbers();
                    updatePreview();
                }
            });
        }

        // Members (Select2) initialization
        function initializeMembers() {
            const $select = $('#membersSelect');
            if ($select.length === 0) return;
            $select.select2({
                theme: 'bootstrap-5',
                placeholder: 'Search and select members...',
                allowClear: true,
                width: '100%',
                templateResult: function (data) {
                    if (!data.id) return data.text;
                    const el = $(data.element);
                    const img = el.data('image-url');
                    const name = el.data('real-name') || data.text;
                    return $(
                        '<div class="member-option">'
                        + (img ? '<img src="'+img+'" alt="avatar">' : '')
                        + '<span class="name">'+ name +'</span>'
                        + '</div>'
                    );
                },
                templateSelection: function (data) {
                    if (!data.id) return data.text;
                    const el = $(data.element);
                    const img = el.data('image-url');
                    const name = el.data('real-name') || data.text;
                    return $(
                        '<div class="member-option">'
                        + (img ? '<img src="'+img+'" alt="avatar">' : '')
                        + '<span class="name">'+ name +'</span>'
                        + '</div>'
                    );
                },
                escapeMarkup: function (m) { return m; }
            });

            // Preselect existing members on edit
            const existingMembers = /*[[${checkInForm.members}]]*/ [];
            if (existingMembers && existingMembers.length > 0) {
                const ids = existingMembers.map(m => m.id);
                $select.val(ids).trigger('change');
            }
        }

        // Live preview functionality
        function updatePreview() {
            const name = document.getElementById('name').value;
            const introMessage = document.getElementById('introMessage').value;
            const outroMessage = document.getElementById('outroMessage').value;
            const previewContent = document.getElementById('previewContent');
            
            if (!name && !introMessage && !outroMessage) {
                previewContent.innerHTML = `
                    <div class="text-muted text-center">
                        <i class="fas fa-eye-slash fa-2x mb-2"></i>
                        <p>Start typing to see a preview of your check-in</p>
                    </div>
                `;
                return;
            }
            
            let previewHtml = '<div class="checkin-preview">';
            
            if (name) {
                previewHtml += `
                    <div class="mb-3">
                        <h5 class="text-primary">
                            <i class="fas fa-tag me-1"></i>
                            ${name}
                        </h5>
                    </div>
                `;
            }
            
            if (introMessage) {
                previewHtml += `
                    <div class="mb-3">
                        <h6 class="text-success">
                            <i class="fas fa-play-circle me-1"></i>
                            Introduction Message
                        </h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0">${introMessage.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            }

            // Questions preview
            const questions = document.querySelectorAll('.question-item');
            if (questions.length > 0) {
                previewHtml += `
                    <div class="mb-3">
                        <h6 class="text-info">
                            <i class="fas fa-question-circle me-1"></i>
                            Questions (${questions.length})
                        </h6>
                `;
                
                questions.forEach((question, index) => {
                    const text = question.querySelector('.question-text').value;
                    
                    if (text.trim()) {
                        previewHtml += `
                            <div class="bg-light p-3 rounded mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="question-number me-2">${index + 1}</div>
                                    <div><strong>${text}</strong></div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                previewHtml += '</div>';
            }
            
            if (outroMessage) {
                previewHtml += `
                    <div class="mb-3">
                        <h6 class="text-info">
                            <i class="fas fa-stop-circle me-1"></i>
                            Conclusion Message
                        </h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0">${outroMessage.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            }
            
            previewHtml += '</div>';
            previewContent.innerHTML = previewHtml;
        }

        // Form submission
        document.getElementById('checkinForm').addEventListener('submit', function(e) {
            // Collect questions data
            const questions = [];
            const questionItems = document.querySelectorAll('.question-item');
            
            questionItems.forEach((item, index) => {
                const text = item.querySelector('.question-text').value.trim();
                if (text) {
                    questions.push({
                        uuid: item.dataset.questionId,
                        text: text,
                        order: index + 1
                    });
                }
            });

            // Add hidden inputs for questions
            questions.forEach((question, index) => {
                const questionPrefix = `questions[${index}]`;
                
                addHiddenInput(questionPrefix + '.uuid', question.uuid);
                addHiddenInput(questionPrefix + '.text', question.text);
                addHiddenInput(questionPrefix + '.order', question.order);
            });

            // Add hidden inputs for members (from Select2)
            const selectedMembers = window.jQuery ? jQuery('#membersSelect').select2('data') : [];
            // Clear previously added member inputs if any
            document.querySelectorAll('#checkinForm input[name^="members["]').forEach(n => n.remove());
            selectedMembers.forEach((m, idx) => {
                if (!m.id) return;
                const realName = (window.jQuery && m.element) ? jQuery(m.element).data('real-name') || m.text : m.text;
                addHiddenInput(`members[${idx}].id`, m.id);
                addHiddenInput(`members[${idx}].realName`, realName);
            });
        });

        function addHiddenInput(name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            document.getElementById('checkinForm').appendChild(input);
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Initialize preview
        updatePreview();
    </script>
</body>
</html>